<% if params[:t] == 'bf' %>
	<% title 'Decline Fees' %>
	<% subtitle "#{current_user.nickname}'s share #{period_covered_helper(params[:q])}" %>
<% else %>
	<% title "#{current_user.nickname}'s Fees" %>
	<% subtitle "for paid orders #{period_covered_helper(params[:q])}" %>
<% end %>

<%= content_tag :h2, class: 'row' do %>
	<%= content_tag :span, ph_currency(@all_fees.supplier_share), class: 'span2' %>
	<%= display_seller_company %>
<% end %>

<%= content_tag :p, page_entries_info(@fees), class: 'muted' %>

	<%= content_tag :table, class: 'table table-condensed' do %>
		<%= content_tag :thead do %>
			<%= content_tag :tr do %>
				<%= content_tag :th, 'Vehicle', class: 'span4' %>
				<%= content_tag :th, 'Parts', class: 'span4' %>
				<%= content_tag :th, 'Lowest Bid', class: 'span2 right' %>
				<%= content_tag :th, 'Factors', class: 'span1 center' %>
				<%= content_tag :th, 'Fee', class: 'span2 right' %>
				<% if params[:t] == 'bf' %>
					<%= content_tag :th, 'Supplier Share', class: 'span2 right' %>
				<% else %>
					<%= content_tag :th, '', class: 'span2 right' %>
				<% end %>
			<% end %>
		<% end %>
		
			<% @fees.group_by{ |o| o.created_at.beginning_of_day }.each do |date, grouped_fees| %>
				<%= content_tag :tr, class: 'well' do %>
					<%= content_tag :td, colspan: 6 do %>
						<%= content_tag :h5, regular_date(date) %>
					<% end %>
				<% end %>

				<% grouped_fees.group_by(&:entry).each do |entry, fees| %>

				<%= content_tag :tr do %>
					<%= content_tag :td, class: 'span4', rowspan: fees.count + 1 do %>
			      <%= content_tag :p, link_to(entry.model_name, seller_show_path(entry))  %>
						<%= content_tag :span, entry.plate_no %>
						<%= content_tag :em, "by #{entry.user.username}", class: 'small' %>
					<% end %>
				<% end %>

				<% for f in fees %>
					<%= content_tag :tr do %>
						<%= content_tag :td, f.line_item.name, class: 'span4' %>
						<%= content_tag :td, class: 'span2 right' do %>
							<% if f.reversal? %>
								<%= content_tag :span, f.fee_type.upcase, :class => 'label'  %>
							<% else %>
								<%= content_tag :span, currency(f.bid_total), class: "" %>
								<%= content_tag :span, f.bid_type[0], class: 'label' %>
							<% end %>
						<% end %>
						<%= content_tag :td, class: 'span2 center small' do %>
							<%= content_tag :em, time_in_words(f.bid_speed) if f.bid_speed %><br>
							<%= content_tag :em, 'PR: ' + f.perf_ratio.to_s if f.perf_ratio %>
						<% end %>
						<%= content_tag :td, class: 'span2 right' do %>
							<%= content_tag :b, currency(f.fee), class: "#{'negative' if f.fee < 0}" if f.fee != 0 %>
							<%= content_tag :p, percentage3(f.fee_rate), class: 'small' if f.fee_rate %>
						<% end %>
						<% if params[:t] == 'bf' %>
							<%= content_tag :td, class: 'span2 right' do %>
								<%= content_tag :b, currency(f.split_amount), class: "#{'negative' if f.fee < 0}" if f.fee != 0  %>
								<%= content_tag :em, f.seller_company.nickname, class: 'small' if f.order_id.nil? %>
							<% end %>
						<% else %>
							<%= content_tag :td, link_to("PO # #{f.order_id}", f.order), class: 'span2 center' %>
						<% end %>
					<% end %>
				<% end %>

				<% end %>

			<% end %>
		
	<% end %>

<%= will_paginate @fees %>

<% content_for :sidebar do %>
	<%= content_tag :h3, 'Search Fees' %>
	<%= search_form_for @q, :url => seller_fees_path(t: params[:t]) do |f| %>
	  <%= f.label 'Plate No.' %>
	  <%= f.text_field :entry_plate_no_cont, class: 'span2' %>
	  <%= f.label 'Buyer' %>
	  <%= content_tag :p, (f.collection_select :buyer_company_id_matches, Company.where(primary_role: 2), :id, :nickname, include_blank: true) %>
	  <%= f.label 'Period Covered' %>
		<%= content_tag :p do %>
		<%= f.text_field :created_at_gteq, id: 'start', class: 'span1 small' %> -
		<%= f.text_field :created_at_lteq, id: 'end', class: 'span1 small' %>
		<% end %>
	  <%= content_tag :p, (f.submit 'Search', class: 'btn btn-primary') %>
	<% end %>
<% end %>

<% content_for :javascripts do %>
	<% stylesheet 'blitzer/jquery-ui-1.8.6.custom' %>
	<script type="text/javascript" charset="utf-8">
	$(function() {
		var dates = $( "#start, #end" ).datepicker({
			dateFormat: "yy-mm-dd",
			maxDate: 0,
			numberOfMonths: 3,
			showButtonPanel: true, 
			showOn: "both",
			buttonImage: '/assets/calendar.gif',
			buttonImageOnly: true,
			onSelect: function( selectedDate ) {
				var option = this.id == "start" ? "minDate" : "maxDate",
					instance = $( this ).data( "datepicker" ),
					date = $.datepicker.parseDate(
						instance.settings.dateFormat ||
						$.datepicker._defaults.dateFormat,
						selectedDate, instance.settings );
				dates.not( this ).datepicker( "option", option, date );
			}
		});
				
	});
	</script>
<% end %>
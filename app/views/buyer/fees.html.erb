<% title 'Decline Fees' %>
<% subtitle "for parts not ordered #{period_covered_helper(params[:q])}" %>

<%= content_tag :h2, class: 'row' do %>
	<%= content_tag :span, ph_currency(@all_fees.total_fee), class: 'span2' %>
	<%= content_tag :small, "Base: #{currency(@all_fees.base_fee)}", class: 'span2' %>
	<%= content_tag :small, "VAT: #{currency(@all_fees.vat)}", class: 'span2' %>
	<%= display_seller_company %>
<% end %>
<%#= content_tag :p, page_entries_info(@fees), class: 'muted' %>

	<%= content_tag :table, class: 'table table-condensed' do %>
		<%= content_tag :thead do %>
			<%= content_tag :tr do %>
				<%= content_tag :th, 'Vehicle', class: 'span4' %>
				<%= content_tag :th, 'Parts', class: 'span4' %>
				<%= content_tag :th, 'Lowest Bid', class: 'span2 txtright' %>
				<%= content_tag :th, 'Factors', class: 'span1 txtcenter' %>
				<%= content_tag :th, 'Fee', class: 'span2 txtright' %>
				<%= content_tag :th, 'Supplier Share', class: 'span2 txtright' %>
			<% end %>
		<% end %>
		
			<% @fees.group_by{ |o| o.created_at.beginning_of_day }.each do |date, grouped_fees| %>
				<%= content_tag :tr, class: 'well' do %>
					<%= content_tag :td, colspan: 6 do %>
						<%= content_tag :h5, regular_date(date) %>
					<% end %>
				<% end %>

				<% grouped_fees.group_by(&:entry).each do |entry, fees| %>

				<%= content_tag :tr do %>
					<%= content_tag :td, class: 'span4', rowspan: fees.count + 1 do %>
			      <%= content_tag :p, link_to(entry.model_name, buyer_show_path(entry))  %>
						<%= content_tag :span, entry.plate_no %>
						<%= content_tag :em, "by #{entry.user.username}", class: 'small' %>
					<% end %>
				<% end %>

				<% for f in fees %>
					<%= content_tag :tr do %>
						<%= content_tag :td, f.line_item.name, class: 'span4' %>
						<%= content_tag :td, class: 'span2 txtright' do %>
							<% if f.reversal? %>
								<%= content_tag :span, f.fee_type.upcase, :class => 'label'  %>
							<% else %>
								<%= content_tag :span, currency(f.bid_total), class: "" %>
								<%= content_tag :span, f.bid_type[0], class: 'label' %>
							<% end %>
						<% end %>
						<%= content_tag :td, class: 'span2 txtcenter small' do %>
							<%= content_tag :em, time_in_words(f.bid_speed) if f.bid_speed %><br>
							<%= content_tag :em, 'PR: ' + f.perf_ratio.to_s if f.perf_ratio %>
						<% end %>
						<%= content_tag :td, class: 'span2 txtright' do %>
							<%= content_tag :b, currency(f.fee), class: "#{'negative' if f.fee < 0}" if f.fee != 0 %>
							<%= content_tag :p, percentage3(f.fee_rate), class: 'small' if f.fee_rate %>
						<% end %>
						<%= content_tag :td, class: 'span2 txtright' do %>
							<%= content_tag :b, currency(f.split_amount), class: "#{'negative' if f.fee < 0}" if f.fee != 0  %>
							<%#= content_tag :p, f.seller_company.nickname, class: 'small' if f.order_id.nil? && f.fee > 0  %>
						<% end %>
					<% end %>
				<% end %>

				<% end %>

			<% end %>
		
	<% end %>

<%= will_paginate @fees %>

<% content_for :sidebar do %>
	<%= content_tag :h3, 'Search Fees' %>
	<%= search_form_for @q, url: buyer_fees_path do |f| %>
	  <%= f.label 'Plate No.' %>
	  <%= f.text_field :entry_plate_no_cont, class: 'span2' %>
	  <%= f.label 'Seller' %>
	  <%= content_tag :p, (f.collection_select :seller_company_id_matches, Company.where(primary_role: 3), :id, :nickname, include_blank: true) %>
	  <%= f.label 'Period Covered' %>
		<%= content_tag :p do %>
		<%= f.text_field :created_at_gteq, id: 'start', class: 'span1 small' %> -
		<%= f.text_field :created_at_lteq, id: 'end', class: 'span1 small' %>
		<% end %>
	  <%= content_tag :p, (f.submit 'Search', class: 'btn btn-primary') %>
	<% end %>
	<hr>
	<%= link_with_icon('Preview', bprint_fees_path(q: params[:q]), 'print') %>
<% end %>

<%= render 'shared/datepicker2' %>

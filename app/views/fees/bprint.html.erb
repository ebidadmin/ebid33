<% title "Decline Fees of #{@buyer_company}" %>
<% subtitle "for parts not ordered" %>
<%= content_tag :p, "Period covered #{period_covered_helper(params[:q])}" %>

<%= content_tag :h2, class: 'row' do %>
	<%= content_tag :span, ph_currency(@all_fees.total_fee), class: 'span2' %>
	<%= content_tag :small, "Base: #{currency(@all_fees.base_fee)}", class: 'span2' %>
	<%= content_tag :small, "VAT: #{currency(@all_fees.vat)}", class: 'span2' %>
	<%= display_seller_company %>
<% end %>

<%= content_tag :table, class: 'table table-condensed' do %>

	<%= content_tag :thead do %>
		<%= content_tag :tr do %>
			<%= content_tag :th, 'Vehicle', class: 'span3' %>
			<%= content_tag :th, 'Parts', class: 'span3' %>
			<%= content_tag :th, 'Lowest Bid', class: 'span2 right' %>
			<%= content_tag :th, 'Factors', class: 'span2 center' %>
			<%= content_tag :th, 'Rate', class: 'span1 center' %>
			<%= content_tag :th, 'Fee', class: 'span1 right' %>
			<%= content_tag :th, 'Supplier Share', class: 'span1 right' %>
		<% end %>
	<% end %>
	
	<% @fees.group_by{ |o| o.created_at.beginning_of_day }.each do |date, grouped_fees| %>
		<%= content_tag :tr, class: 'well' do %>
			<%= content_tag :td, colspan: 7 do %>
				<%= content_tag :h5, regular_date(date) %>
			<% end %>
		<% end %>

		<% grouped_fees.group_by(&:entry).each do |entry, fees| %>
			<%= content_tag :tr do %>
				<%= content_tag :td, class: 'span3', rowspan: fees.count + 1 do %>
		      <%= content_tag :p, link_to(entry.model_name, buyer_show_path(entry))  %>
					<%= content_tag :span, entry.plate_no %>
					<%= content_tag :em, "by #{entry.user.username}", class: 'small' %>
				<% end %>
			<% end %>

			<% for f in fees %>
				<%= content_tag :tr do %>
					<%= content_tag :td, f.line_item.name, class: 'span3' %>
					<%= content_tag :td, class: 'span2 right' do %>
						<% if f.reversal? %>
							<%= content_tag :span, f.fee_type.upcase, :class => 'label'  %>
						<% else %>
							<%= content_tag :span, currency(f.bid_total), class: "" %>
							<%= content_tag :span, f.bid_type[0], class: 'label' %>
						<% end %>
					<% end %>
					<%= content_tag :td, class: 'span2 center small' do %>
						<%= content_tag :em, time_in_words(f.bid_speed) if f.bid_speed %> 
						<%#= content_tag :em, 'PR: ' + f.perf_ratio.to_s if f.perf_ratio %>
					<% end %>
					<%= content_tag :td, percentage3(f.fee_rate), class: 'span1 center small' %>
					<%= content_tag :td, class: 'span1 right' do %>
						<%= content_tag :b, currency(f.fee), class: "#{'negative' if f.fee < 0}" if f.fee != 0 %>
					<% end %>
					<%= content_tag :td, class: 'span1 right' do %>
						<%= content_tag :b, currency(f.split_amount), class: "#{'negative' if f.fee < 0}" if f.fee != 0  %>
						<%#= content_tag :p, f.seller_company.nickname, class: 'small' if f.order_id.nil? && f.fee > 0  %>
					<% end %>
				<% end %>
			<% end %>		
		<% end %>
	<% end %>

	<%= content_tag :tr, class: 'total' do %>
		<%= content_tag :td, '', rowspan: 4, colspan: 3  %>
		<%= content_tag :td, 'Sub-totals', class: 'right', colspan: 2 %>
		<%= content_tag :td, class: 'right' do %>
			<%= content_tag :p, currency(@fees.base_fee) %>
		<% end %>
		<%= content_tag :td, class: 'right' do %>
			<%= content_tag :p, currency(@fees.supplier_share) %>
		<% end %>
	<% end %>
	<%= content_tag :tr, class: 'total' do %>
		<%= content_tag :td, 'VAT', class: 'right', colspan: 2 %>
		<%= content_tag :td, class: 'right' do %>
			<%= content_tag :p, currency(@fees.vat) %>
		<% end %>
		<%= content_tag :td %>
	<% end %>
	<%= content_tag :tr, class: 'total' do %>
		<%= content_tag :td, 'Totals', class: 'right', colspan: 2 %>
		<%= content_tag :td, class: 'right' do %>
			<%= content_tag :p, currency(@fees.total_fee) %>
		<% end %>
		<%= content_tag :td, class: 'right' do %>
			<%= content_tag :p, currency(@fees.supplier_share) %>
		<% end %>
	<% end %>
	
<% end %>
